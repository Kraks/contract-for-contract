%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}


%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{CONF} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2018}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmauthoryear}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[scaled=0.8]{beramono}
\usepackage{amsmath}
\usepackage{color}
\usepackage{xcolor,colortbl}
\usepackage{url}
\usepackage{listings}
\usepackage{paralist}
%\usepackage[compact]{titlesec}
\usepackage{caption}
\usepackage{wrapfig}
\usepackage{enumitem}
\usepackage{multicol}
\usepackage{flushend}
\usepackage{textcomp}
\usepackage{pdfpages}
\usepackage{cleveref}
\usepackage{xspace}
\definecolor{light-gray}{gray}{0.85}

\input{macros}

\begin{document}

%% Title information
\title[Short Title]{Contracts for Contracts}         %% [Short Title] is optional;
%\title[Short Title]{Contracts meet Contracts}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
\titlenote{with title note}             %% \titlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'
%\subtitle{Adding Higher-Order Contracts for Smart Contracts}                     %% \subtitle is optional
%\subtitle{Expressive Assertion Monitoring System for Safer Smart Contracts}                     %% \subtitle is optional
\subtitle{Expressive Temporal Higher-Order Behavioral Contracts for Smart Contracts}                     %% \subtitle is optional
\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
                                        %% can be repeated if necessary;
                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
\author{First1 Last1}
\authornote{with author1 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position1}
  \department{Department1}              %% \department is recommended
  \institution{Institution1}            %% \institution is required
  \streetaddress{Street1 Address1}
  \city{City1}
  \state{State1}
  \postcode{Post-Code1}
  \country{Country1}                    %% \country is recommended
}
\email{first1.last1@inst1.edu}          %% \email is recommended

%% Author with two affiliations and emails.
\author{First2 Last2}
\authornote{with author2 note}          %% \authornote is optional;
                                        %% can be repeated if necessary
\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
\affiliation{
  \position{Position2a}
  \department{Department2a}             %% \department is recommended
  \institution{Institution2a}           %% \institution is required
  \streetaddress{Street2a Address2a}
  \city{City2a}
  \state{State2a}
  \postcode{Post-Code2a}
  \country{Country2a}                   %% \country is recommended
}
\email{first2.last2@inst2a.com}         %% \email is recommended
\affiliation{
  \position{Position2b}
  \department{Department2b}             %% \department is recommended
  \institution{Institution2b}           %% \institution is required
  \streetaddress{Street3b Address2b}
  \city{City2b}
  \state{State2b}
  \postcode{Post-Code2b}
  \country{Country2b}                   %% \country is recommended
}
\email{first2.last2@inst2b.org}         %% \email is recommended

\lstMakeShortInline[keywordstyle=,%
                    flexiblecolumns=false,%
                    %basewidth={0.56em, 0.52em},%
                    mathescape=false,%
                    basicstyle=\ttfamily]@

%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
\begin{abstract}
Text of abstract \ldots.
\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Software and its engineering~General programming languages}
\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\keywords{keyword1, keyword2, keyword3}  %% \keywords are mandatory in final camera-ready submission


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

%https://se.inf.ethz.ch/~meyer/publications/old/dbc_chapter.pdf
%https://docs.soliditylang.org/en/v0.8.17/control-structures.html?highlight=require#panic-via-assert-and-error-via-require

\section{Introduction}

%\todo{why? solidity is rather flexible, unsatisfying/weaker type system,
%not all invariants can be checked statically, e.g. the status of the chain}
%One \note{common} use case of higher-order functions in smart contracts is
%to express callback \todo{explain how it is used}.

%\todo{it is hard to enforce properties when callbacks exist}
%Static verification cannot completely address the issue here since
%transaction developers are oblivious to the user-provided callback.

%Building trustworthy and secure smart contract programs requires solid
%understanding and reliable enforcement of program invariants.

Smart contracts are programs to automate the execution of agreement so that all
parties involved in the agreement can be certain about the outcome.
Smart contracts are ``smart'' since by using blockchains they provide a
mechanism to \emph{ensure the economic outcome of transactions} without a
central authority.
A blockchain implements a consensus protocol of Byzantine-fault-tolerant
distributed ledgers.

It is however ironic that many popular smart contract languages, which hold the
great promise to ensure transactional outcomes via consensus and distributed
ledgers, do not provide enough means to \emph{ensure the quality of programs}.
Without ensuring the quality of programs, it is impossible to ensure
the economic outcome of transactions.

For example, Solidity provides first-order assertion primitives @require@ and
@assert@, but they cannot check function values (e.g. used as callbacks), which are a
common pattern used in smart contract programs. Attackers are able to utilize
the callback mechanism to \note{do crazy things and steal money}
Solidity also provides the @modifier@ mechanism that intercepts
before and after a function call, thus can be used to check
pre- and post-conditions.
\todo{can we compose modifier?}
\todo{can we attach modifier to callbacks?}
\todo{can we use modifier to check function's argument?}

The lack of sufficient linguistic means to specify and enforce subtle behaviors
discourages programmers to use higher-level abstractions when writing smart
contract code.
Instead, to be secure, programmers are obliged to write verbose code with
lower-level abstractions, which conflates the main business logic and
behavioral checks, leading to poor readability and maintainability.
For instance, to defend the famous DAO attack \note{cite} caused by allowing ``reentrancy''
via external functions, programmers have to be extra cautious about the execution
order or maintain additional states to check if a call is allowed.
Either way is not ideal.
And often worse, defensive checks are disregarded, leading to vulnerable code
causing real monetary lose.

Despite hindsight effort to audit, certify, or verify smart contract programs,
language designers are responsible to provide better languages so that
programmers are able to write invulnerable smart contracts in the first place.
In this paper, we argue that advanced \emph{behavioral contracts} provide a
lightweight linguistic solution for many security issues found in smart
contract programs.

\subsubsection*{\textbf{Behavioral Contracts for Smart Contracts}}
Behavioral contracts provide a mechanism for programmers to specify assumptions
and guarantees of software components. The specified assumptions and guarantees
will be monitored and reported when violated.
Pioneered by the Eiffel language \cite{DBLP:books/ph/Meyer91} and the
Design-by-Contract methodology \cite{DBLP:conf/tools/Meyer98a}, behavioral
contracts have been widely adopted in Java, Haskell, C\#, Python, Racket,
Elixir \cite{DBLP:conf/erlang/0001BBHMEF22}, etc. \todo{cite}

\todo{why BC is good here?}

At the conceptual level, behavioral contracts is complementary to smart
contracts, in the sense that they are both agreement -- between software
components for the former, and between transactional parties for the later.
Thus, the two terms ``contract'' indeed mean the same thing but just different
levels of enforcement.

In this work, we design and implement a practical extension of Solidity, the
most popular language for building smart contract programs. The extension
enriches the Solidity language with \emph{temporal} and \emph{higher-order} behavioral
contracts, which checks \todo{...}
We develop a core model of the extension, including its syntax,
operational semantics, and discuss its soundness guarantee.

With the behavioral contract extension of Solidity, we examine
\note{N} cases of reported bugs and vulnerabilities and show that
our approach is effective in preventing these attacks.

\todo{discuss performance/gas consumption}

\subsubsection*{\textbf{Contributions}} This paper makes the following contributions:
\begin{itemize}
  \item We propose to add temporal and higher-order contracts to smart contract
    languages to improve the safety and reliability. We use Solidity to
    demonstrate our proposal.
  \item We present the core language ``Contract Solidity'' with our
    proposed extension, including its syntax, formal semantics, and soundness.
  \item We examine a number of real-world cases and show that our proposal is
    effective in improving safety and reliability.
  \item We implement our approach on top of the existing Solidity compiler and shows
    that its runtime overhead is marginal.
\end{itemize}

\section{Motivation}

an interesting case that shows with contracts for contracts the world will be better;
how much money it could save for people

\section{Contract Solidity}

informal description and examples of the language dubbed ``Contract Solidity''

\begin{lstlisting}
  def test(x: Int): Int = x + 1
\end{lstlisting}

\section{Formal Model}

the core model of the language (TODO named?)
\todo{there must be some interesting points/trade-offs about the design}

\subsection{Syntax}

\subsection{Semantics}

\subsection{Soundness}

what does it guarantee

\section{Case Studies}

examining 3-4 cases, they are the proof that the approach works

\subsection{Reentrancy}

\subsection{Callback}

\subsection{Comparison with \texttt{modifier}}

\todo{what else?}

\section{Implementation}

the implementation that modifies the off-the-shelf Solidity compiler that
supports contracts and generates code with correct contracts checking

\section{Performance Evaluation}

\section{Related Work}

\subsubsection*{\textbf{Behavioral Contracts}}

Eiffel the ``design-by-contract'' methodology \cite{DBLP:books/ph/Meyer91, DBLP:conf/tools/Meyer98a}

higher-order contract \cite{DBLP:conf/icfp/FindlerF02}

temporal higher-order contract \cite{DBLP:conf/icfp/DisneyFM11}

\subsubsection*{\textbf{Smart Contracts}}

runtime validation, reduce overhead of runtime checks \cite{DBLP:conf/pldi/LiCL20}

security analyzer \cite{DBLP:conf/pldi/BrentGLSS20}

nondeterminisitic payment bugs \cite{DBLP:journals/pacmpl/WangZS19}

behavioral simulation to verify smart contracts \cite{DBLP:conf/pldi/BeillahiCEE20}

formal and modular specification of smart contracts \cite{DBLP:journals/pacmpl/BramEMSS21}

static analysis to infer ownership and commutativity summaries, for parallelism
\cite{DBLP:conf/pldi/Pirlea0S21}

callbacks \cite{DBLP:journals/pacmpl/AlbertGRRRS20, DBLP:journals/pacmpl/GrossmanAGMRSZ18}

reduce gas consumption \cite{DBLP:journals/pacmpl/GrechKJBSS18}

static analysis of Ethereum \cite{DBLP:journals/pacmpl/SmaragdakisGLTT21}

\section{Conclusion}


%% Acknowledgments
\begin{acks}                            %% acks environment is optional
                                        %% contents suppressed with 'anonymous'
  %% Commands \grantsponsor{<sponsorID>}{<name>}{<url>} and
  %% \grantnum[<url>]{<sponsorID>}{<number>} should be used to
  %% acknowledge financial support and will be used by metadata
  %% extraction tools.
  This material is based upon work supported by the
  \grantsponsor{GS100000001}{National Science
    Foundation}{http://dx.doi.org/10.13039/100000001} under Grant
  No.~\grantnum{GS100000001}{nnnnnnn} and Grant
  No.~\grantnum{GS100000001}{mmmmmmm}.  Any opinions, findings, and
  conclusions or recommendations expressed in this material are those
  of the author and do not necessarily reflect the views of the
  National Science Foundation.
\end{acks}


%% Bibliography
\bibliography{references}


%% Appendix
%\appendix
%\section{Appendix}

Text of appendix \ldots

\end{document}
